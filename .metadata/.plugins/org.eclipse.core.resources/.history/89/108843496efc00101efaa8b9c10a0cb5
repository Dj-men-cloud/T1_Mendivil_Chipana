package org.cibertec.app;

import java.awt.EventQueue;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.List;
import javax.swing.*;
import javax.swing.border.EmptyBorder;
import org.cibertec.controlador.*;
import org.cibertec.model.*;

public class RegistroApellido extends JFrame {

    private static final long serialVersionUID = 1L;
    private JPanel contentPane;
    private JTextField txtNroInventario, txtCosto, txtMotivo;
    private JComboBox<Producto> cboProductos;
    private JTextArea txtSalida;
    
    // Controladores
    private InventarioJpaController jpaInventario;
    private ProductoJpaController jpaProducto;

    public static void main(String[] args) {
        EventQueue.invokeLater(() -> {
            try {
                RegistroApellido frame = new RegistroApellido();
                frame.setVisible(true);
            } catch (Exception e) {
                e.printStackTrace();
            }
        });
    }

    public RegistroApellido() {
        jpaInventario = new InventarioJpaController();
        jpaProducto = new ProductoJpaController();
        
        setTitle("Mantenimiento de Inventarios");
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setBounds(100, 100, 500, 450);
        contentPane = new JPanel();
        contentPane.setBorder(new EmptyBorder(5, 5, 5, 5));
        setContentPane(contentPane);
        contentPane.setLayout(null);

        // --- Etiquetas y Campos ---
        JLabel lblNro = new JLabel("Nro. Inventario:");
        lblNro.setBounds(10, 11, 110, 14);
        contentPane.add(lblNro);

        txtNroInventario = new JTextField();
        txtNroInventario.setBounds(130, 8, 86, 20);
        contentPane.add(txtNroInventario);
        txtNroInventario.setEnabled(false); // Es Identity en la BD

        JLabel lblProd = new JLabel("Producto:");
        lblProd.setBounds(10, 45, 110, 14);
        contentPane.add(lblProd);

        cboProductos = new JComboBox<Producto>();
        cboProductos.setBounds(130, 41, 200, 22);
        contentPane.add(cboProductos);

        JLabel lblCosto = new JLabel("Costo Ingreso:");
        lblCosto.setBounds(10, 80, 110, 14);
        contentPane.add(lblCosto);

        txtCosto = new JTextField();
        txtCosto.setBounds(130, 77, 86, 20);
        contentPane.add(txtCosto);

        JLabel lblMotivo = new JLabel("Motivo Ingreso:");
        lblMotivo.setBounds(10, 115, 110, 14);
        contentPane.add(lblMotivo);

        txtMotivo = new JTextField();
        txtMotivo.setBounds(130, 112, 200, 20);
        contentPane.add(txtMotivo);

        // --- Botones ---
        JButton btnRegistrar = new JButton("Registrar");
        btnRegistrar.addActionListener(e -> registrar());
        btnRegistrar.setBounds(360, 41, 100, 23);
        contentPane.add(btnRegistrar);

        JButton btnActualizar = new JButton("Actualizar");
        btnActualizar.addActionListener(e -> actualizar());
        btnActualizar.setBounds(360, 76, 100, 23);
        contentPane.add(btnActualizar);

        JButton btnBuscar = new JButton("Buscar");
        btnBuscar.addActionListener(e -> buscar());
        btnBuscar.setBounds(226, 7, 89, 23);
        contentPane.add(btnBuscar);

        JScrollPane scrollPane = new JScrollPane();
        scrollPane.setBounds(10, 160, 464, 200);
        contentPane.add(scrollPane);

        txtSalida = new JTextArea();
        scrollPane.setViewportView(txtSalida);

        // Inicialización
        txtNroInventario.setEnabled(true); // Se habilita para Buscar o Actualizar
        llenaCombo();
    }

    void llenaCombo() {
        cboProductos.removeAllItems();
        cboProductos.addItem(null);
        List<Producto> lista = jpaProducto.findAllProducto();
        for (Producto p : lista) {
            cboProductos.addItem(p);
        }
    }

    void registrar() {
        try {
            Inventario inv = new Inventario();
            // Captura de datos
            Producto p = (Producto) cboProductos.getSelectedItem();
            if(p == null) {
                JOptionPane.showMessageDialog(this, "Seleccione un producto");
                return;
            }
            
            inv.setIdProducto(p);
            inv.setCostoIngreso(txtCosto.getText()); // Nota: En tu clase es String
            inv.setMotivoIngreso(Double.parseDouble(txtMotivo.getText())); // Nota: En tu clase es Double
            
            // FECHA DEL SISTEMA (java.sql.Date)
            long millis = System.currentTimeMillis();
            inv.setFecha(new java.sql.Date(millis));
            
            jpaInventario.registrar(inv);
            JOptionPane.showMessageDialog(this, "Éxito al registrar");
            limpiar();
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "Error: " + e.getMessage());
        }
    }

    void actualizar() {
        try {
            int id = Integer.parseInt(txtNroInventario.getText());
            Inventario inv = jpaInventario.buscarById(id);
            
            if(inv != null) {
                inv.setIdProducto((Producto) cboProductos.getSelectedItem());
                inv.setCostoIngreso(txtCosto.getText());
                inv.setMotivoIngreso(Double.parseDouble(txtMotivo.getText()));
                
                jpaInventario.actualizar(inv);
                JOptionPane.showMessageDialog(this, "Éxito al actualizar");
                limpiar();
            }
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "Error: " + e.getMessage());
        }
    }

    void buscar() {
        try {
            int id = Integer.parseInt(txtNroInventario.getText());
            Inventario inv = jpaInventario.buscarById(id);
            if (inv != null) {
                txtCosto.setText(inv.getCostoIngreso());
                txtMotivo.setText(String.valueOf(inv.getMotivoIngreso()));
                seleccionarProductoEnCombo(inv.getIdProducto().getIdProd());
                txtSalida.setText("Encontrado: " + inv.toString());
            } else {
                JOptionPane.showMessageDialog(this, "No existe el inventario");
            }
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "Ingrese un código válido");
        }
    }

    void seleccionarProductoEnCombo(int idProd) {
        for (int i = 1; i < cboProductos.getItemCount(); i++) {
            if (cboProductos.getItemAt(i).getIdProd() == idProd) {
                cboProductos.setSelectedIndex(i);
                break;
            }
        }
    }

    void limpiar() {
        txtNroInventario.setText("");
        txtCosto.setText("");
        txtMotivo.setText("");
        cboProductos.setSelectedIndex(0);
    }
}